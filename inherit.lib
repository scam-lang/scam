; Java style inheritance in three functions (really two, super is not needed)
; linear time

(include "reflection.lib")

(define (resetClosures static obj)
    (define (update current rest)
        (if (closure? current) (set! __context static current))
        (if (neq? rest nil) (update (car rest) (cdr rest)))
        )
    (define values (locals obj))
    ;(println "locals are " values)
    (if (!= values nil) (update (car values) (cdr values)))
    obj
    )

(define (inherit child parents reification static)
    ;(println "inherit " (list child parents reification static) "...")
    (if (null? parents)
        (set! __context static child)
        (set! __context
              (inherit (resetClosures reification (car parents))
                       (cdr parents) reification static)
              child
              )
        )
    (set! __label (. (. child __constructor) name) child)
    child
    )

(define (new child)
    ;(println "new...")
    (define (chain x) (if (null? x) nil (cons x (chain (get 'parent x)))))
    (inherit child (chain (get 'parent child)) child (get __context child))
    )

(define (mixin object @)
    (inherit object @ object (get __context object))
    )

(define (super child)
    (get __context child)
    )

(define (extend # parent)
    (define top
        (if (local? 'inherit-top parent) (get 'inherit-top parent) parent))
    
    ;(println "in extend...")
    (addSymbol 'inherit-top top #)
    
    (set! __context (get __context #) top)
    (set! __context parent #)
    #
    )
