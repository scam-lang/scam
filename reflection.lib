(define (class x) (get __label x))
(define (is? x y)
    (cond
        ((null? x) #f)
        ((not (environment? x)) (eq? (type x) y))
        ((and (environment? x) (or (eq? y 'environment) (eq? y 'object))) #t)
        ((and (valid? (. x __constructor)) (eq? (. x __constructor name) y)) #t)
        (else (and (local? 'parent x) (is? (. x parent) y)))
        )
    )
(define (object? x) (and (pair? x) (eq? (car x) 'object)))
(define (closure? x) (and (object? x) (eq? (class x) 'closure)))
(define (error? x) (and (object? x) (eq? (class x) 'error)))
(define (environment? x) (and (object? x) (eq? (class x) 'environment)))


(define (local? id env)
    (member? id (localNames env))
    )

(define (defined? # id env)
    (define result (catch (eval id #)))
    (not (error? result))
    )

(define (localNames env)
    (cadr env)
    )

(define (localValues env)
    (caddr env)
    )

(define (prior #)
    (define f (dot # __constructor))
    (cond
        ((and (valid? f) (local? '__prior f))
            (get __prior f)
            )
        ((valid? f)
            (define name (dot f name))
            (define denv (dot f __context))
            (define vars (localNames denv))
            (define vals (localValues denv))
            (define started #f)
            (define found #f)
            (define result nil)
            (while (and (not found) (valid? vars))
                (cond
                    ((and started (eq? name (car vars)))
                        (assign found #t)
                        (assign result (car vals))
                        )
                    ((and (eq? name (car vars)) (eq? f (car vals)))
                        (assign started #t)
                        )
                    )
                (assign vars (cdr vars))
                (assign vals (cdr vals))
                )
            result
            )
        (else nil)
        )
    )

(define (setPrior f g)
    (cond
        ((local? '__prior f)
            (set! __prior g)
            )
        (else
            (addSymbol '__prior g f)
            )
        )
    )

